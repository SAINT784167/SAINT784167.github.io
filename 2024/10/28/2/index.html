<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>基于yolov5、fcos的目标识别跟踪系统 | zzzzzzjl</title><meta name="author" content="Zhang JianLin"><meta name="copyright" content="Zhang JianLin"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="基于yolov5、fcos的目标识别跟踪系统​    几个月前做一个需求，需要做一个关于一类物体的识别和跟踪任务。当时首先考虑到是一类物体、身份的识别，使用单纯的对一个特定物体特征提取的识别并不能帮助我对一类物体进行识别跟踪，因此，我打算使用yolo这种端到端的目标识别算法。后来考虑到我需要部署的平台算力又很有限，同时还要注重实时性，也就是通讯速率的问题，这种情况下对于我实时监测的帧数fps要求很">
<meta property="og:type" content="article">
<meta property="og:title" content="基于yolov5、fcos的目标识别跟踪系统">
<meta property="og:url" content="http://bl-zjl-og.cn/2024/10/28/2/index.html">
<meta property="og:site_name" content="zzzzzzjl">
<meta property="og:description" content="基于yolov5、fcos的目标识别跟踪系统​    几个月前做一个需求，需要做一个关于一类物体的识别和跟踪任务。当时首先考虑到是一类物体、身份的识别，使用单纯的对一个特定物体特征提取的识别并不能帮助我对一类物体进行识别跟踪，因此，我打算使用yolo这种端到端的目标识别算法。后来考虑到我需要部署的平台算力又很有限，同时还要注重实时性，也就是通讯速率的问题，这种情况下对于我实时监测的帧数fps要求很">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://bl-zjl-og.cn/img/cover1.jpg">
<meta property="article:published_time" content="2024-10-27T16:00:00.000Z">
<meta property="article:modified_time" content="2024-11-25T15:45:26.175Z">
<meta property="article:author" content="Zhang JianLin">
<meta property="article:tag" content="yolov5">
<meta property="article:tag" content="STM32">
<meta property="article:tag" content="python">
<meta property="article:tag" content="计算机视觉">
<meta property="article:tag" content="fcos">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://bl-zjl-og.cn/img/cover1.jpg"><link rel="shortcut icon" href="/img/title.png"><link rel="canonical" href="http://bl-zjl-og.cn/2024/10/28/2/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        if (name && globalFn[key][name]) return
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":true,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '基于yolov5、fcos的目标识别跟踪系统',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-11-25 23:45:26'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background: black;"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/head1.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">3</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/cover1.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/img/title.png" alt="Logo"><span class="site-name">zzzzzzjl</span></a><a class="nav-page-title" href="/"><span class="site-name">基于yolov5、fcos的目标识别跟踪系统</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">基于yolov5、fcos的目标识别跟踪系统</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-10-27T16:00:00.000Z" title="发表于 2024-10-28 00:00:00">2024-10-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-11-25T15:45:26.175Z" title="更新于 2024-11-25 23:45:26">2024-11-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89/">计算机视觉</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="基于yolov5、fcos的目标识别跟踪系统"><a href="#基于yolov5、fcos的目标识别跟踪系统" class="headerlink" title="基于yolov5、fcos的目标识别跟踪系统"></a>基于yolov5、fcos的目标识别跟踪系统</h1><p>​    几个月前做一个需求，需要做一个关于一类物体的识别和跟踪任务。当时首先考虑到是一类物体、身份的识别，使用单纯的对一个特定物体特征提取的识别并不能帮助我对一类物体进行识别跟踪，因此，我打算使用yolo这种端到端的目标识别算法。后来考虑到我需要部署的平台算力又很有限，同时还要注重实时性，也就是通讯速率的问题，这种情况下对于我实时监测的帧数fps要求很高，还需要部署加速模型。</p>
<p>​    思来想去，树莓派上能够利用的加速方案即便加速了也不够识别算法的要求（onnx转ncnn等，加速之后大概也在10fps以下，仍然不够，个人建议稳定20fps以上），最后选择地瓜机器人（原地平线x3派），使用板载部署fcos跟踪识别。板载使用双核BPU资源，（AI算力达到5TOPS，比香橙派更小）将后处理等操作从神经元网络中提出来单独放在板上跑，最终能够稳定30fps（如果想跑自己的识别算法，需要通过docker将onnx文件转为bin文件，挂载天工开物toolchain），在部署代码中加入串口通讯等内容将识别数据与下位机通讯，从而达到跟踪的目的。</p>
<p>​    <strong>本项目学习逻辑顺序：首先，我们需要知道在电脑端部署上位机过程及输出过程，因为pc端属于算力相当充足的平台，可以看作理想平台，在此基础上，我们写下位机的逻辑代码，并搭建通讯协议，这时我们可以测试下位机的代码逻辑在理想平台运行下是否正确，也即电脑做上位机，32做下位机；测试完成后，再将上位机移植到算力有限平台，在此过程中，我们只需要解决有关通讯速率的问题就好了。</strong></p>
<p>​    博客主要内容为：</p>
<p>​        1.将yolo算法本地运行以及部署至树莓派的过程；</p>
<p>​        2.使用x3派官方部署的fcos识别作为上位机去与下位机通讯，完成识别并跟踪的需求。</p>
<h1 id="方案设计-amp-引脚分配。"><a href="#方案设计-amp-引脚分配。" class="headerlink" title="方案设计&amp;引脚分配。"></a>方案设计&amp;引脚分配。</h1><p>​    本案例采用单目摄像头识别，通过usb连接地平线X3派。地平线X3派官方已经安装好USB转TTL驱动（若这里使用的是树莓派，则一定要提前看下位机使用usb转ttl通讯的芯片型号安装驱动），通过usb连接STM32F103C8T6驱动板，板载获取信息后发出PWM波信号控制舵机转动。具体接线如下图所示：</p>
<p><img src="/2024/10/28/2/yolo.png" alt></p>
<p>​    其中，由电脑通过typeC对typeC口对地平线X3派供电，地平线和下位机通过usb对typec口通信，并且通过该线对下位机供电。此处供电只对PWM输出口其中一半的引脚进行供电，在测试时，若接入其中未供电的引脚，舵机会发出电流异响。下两图是下位机的原理图以及系统引脚分配:</p>
<p><img src="/2024/10/28/2/ylt.png" alt></p>
<p>引脚分配：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>需求</th>
<th>需求个数</th>
<th>使用功能</th>
<th>引脚对应</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>底部旋转舵机</td>
<td>1</td>
<td>使用TIM4定时器功能产生PWM波形（output）</td>
<td>PB6（R26）</td>
<td>TIM4      PWMgenerationCH1</td>
</tr>
<tr>
<td>俯仰舵机</td>
<td>1</td>
<td>使用TIM4定时器功能产生PWM波形（output）</td>
<td>PB7(R27)</td>
<td>TIM4 PWMgenerationCH2</td>
</tr>
<tr>
<td>串口通讯与接收</td>
<td>1</td>
<td>在调试时可以使用电脑usb口直接进行串口通信，或者在打开串口通信设置后，进行引脚引出</td>
<td>PA13/PA14复用功能</td>
<td>通过usb进行通讯，改为串口通信</td>
</tr>
<tr>
<td>OLED屏幕显示</td>
<td>1</td>
<td>在调试时返回变换前和后的坐标值</td>
<td>PB5\PB4\PB3\PA15</td>
<td>使用SPI1通讯；对外推挽输出即可</td>
</tr>
<tr>
<td>KY-008激光模块</td>
<td>1</td>
<td>数字IO口（舵机占用）</td>
<td>PB8（R29）</td>
<td>一边接地，一边直接接入GPIO口即可。</td>
</tr>
<tr>
<td>syn6288语音播报模块</td>
<td>1</td>
<td>输出实时合成中文字符</td>
<td>PB10isTX/PB11isRX</td>
<td>串口资源3，目前已经禁用，使用socket协议直接和工控机通讯即可。</td>
</tr>
<tr>
<td>DEBUG</td>
<td>1</td>
<td></td>
<td>PA4</td>
<td>LEDBLUE</td>
</tr>
<tr>
<td>stlink</td>
<td>4</td>
<td>下载与调试</td>
<td>下4：swclk-PA14 swdio-PA13 3.3-3.3 GND-GND</td>
<td></td>
</tr>
<tr>
<td><strong>上位机接线需求</strong></td>
<td><strong>需求个数</strong></td>
<td><strong>使用功能</strong></td>
<td><strong>引脚对应</strong></td>
<td><strong>说明</strong></td>
</tr>
<tr>
<td>以太网远程桌面</td>
<td>1</td>
<td>VNCVIEWER</td>
<td>RJ45端子接网线</td>
<td>链接树莓派或X3派时，需要指定本地以太网IPV4地址为固定，树莓派请参考CSDN上教程，X3派请进入网络与共享中心-更改适配器设置-IPV4地址-属性-192.168.0.100（参照地平线手册）</td>
</tr>
<tr>
<td>通讯</td>
<td>1</td>
<td>usb</td>
<td>usb3.0</td>
<td></td>
</tr>
<tr>
<td>摄像头</td>
<td>1</td>
<td>usb</td>
<td>usb3.0</td>
<td>注意，若是定焦需要记住焦距，若是变焦则需要确定出厂焦距（目前焦距），如果实在记不住也没关系</td>
</tr>
</tbody>
</table>
</div>
<h1 id="在计算机本地下载并应用yolo算法。"><a href="#在计算机本地下载并应用yolo算法。" class="headerlink" title="在计算机本地下载并应用yolo算法。"></a>在计算机本地下载并应用yolo算法。</h1><h3 id="配置环境。"><a href="#配置环境。" class="headerlink" title="配置环境。"></a>配置环境。</h3><p>​    由于平台部署算力有限，因此选择使用YOLOV5-LITE轻量化版本。由于YOLOV5LITE的1.5版本export的环境与我所搭配的主环境冲突，于是选择1.4版本。以下是我的环境：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CUDA版本:12.1</span><br><span class="line">Python=3.11		matplotlib=3.8.3	opencv-python=4.9.0.80		pillow=10.2.0 </span><br><span class="line">scipy=1.12.0 	torch=2.2.1 		torchversion=0.17.1 		tensorboard=2.16.2 </span><br><span class="line">seaborn=0.13.2 	pandas 				serial（通讯）</span><br></pre></td></tr></table></figure>
<p>​    使用conda创建虚拟环境命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">conda create -n env_name python=3.11#创建环境以及python版本</span><br><span class="line">conda env list#显示所有环境或者cd进入conda的evns中去ls</span><br><span class="line">conda activate env_name#激活进入环境中，可以在激活后在powershell中下载并配置环境</span><br></pre></td></tr></table></figure>
<h3 id="本地运行YOLOV5。"><a href="#本地运行YOLOV5。" class="headerlink" title="本地运行YOLOV5。"></a>本地运行YOLOV5。</h3><p>​    前往：<a target="_blank" rel="noopener" href="https://github.com/ppogg/YOLOv5-Lite，下载源代码.zip至本地。">https://github.com/ppogg/YOLOv5-Lite，下载源代码.zip至本地。</a></p>
<p>​    在release中下载.pt预权重文件，这里使用YOLOV5LITE-S.pt文件，使用权重文件的s版本（最简化）。</p>
<p>​    以下是对YOLOV5LITE-1.4源码进行一些最基本的处理：</p>
<p>​        到基础能用的地步，更改所涉及到的文件：detect.py、plot.py、datasets.py</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">detect.py#</span><br><span class="line">#修改1：修改预训练权重文件的绝对地址------------------------------------------------------------------------------</span><br><span class="line">parser.add_argument(&#x27;--weights&#x27;, nargs=&#x27;+&#x27;, type=str, default=&#x27;D:/YOLOv5-		Litev1.5/v5lites.pt&#x27;,help=&#x27;model.pt path(s)&#x27;)#此处default修改为自己下载的.pt文件的绝对地址</span><br><span class="line">#修改2：将YOLO从从指定地址读取图片识别模式修改至使用本地摄像头实时检测模式----------------------------------------------</span><br><span class="line">parser.add_argument(&#x27;--source&#x27;, type=str, default=&#x27;0&#x27;, help=&#x27;source&#x27;) #default修改为绝对地址为图片识别，若为0、1等等则为使用该数字端口的摄像头，一般0为本地，1为所接的第一个外部摄像头</span><br><span class="line"></span><br><span class="line">datasets.py</span><br><span class="line">#若要调用摄像头，同时还要在utils文件夹中logging文件夹下的datasets需要修改第279行代码，以下是datasets语言文件下代码修改：</span><br><span class="line">if &#x27;youtube.com/&#x27; in str(url) or &#x27;youtu.be/&#x27; in str(url): # if source is</span><br><span class="line">YouTube video</span><br><span class="line">#str(url)是本地摄像头，从url修改为str(url)</span><br><span class="line">check_requirements((&#x27;pafy&#x27;, &#x27;youtube_dl&#x27;))</span><br><span class="line"></span><br><span class="line">plot.py</span><br><span class="line">#修改3：输出获取中线点坐标并显示---------------------------------------------------------------------------------</span><br><span class="line">#在plot.py中ctrl+h搜索plot_one_box函数，并将函数修改至如下：</span><br><span class="line">def plot_one_box(x, img, color=None, label=None, line_thickness=3):</span><br><span class="line"># Plots one bounding box on image img</span><br><span class="line">	tl = line_thickness or round(0.002 * (img.shape[0] + img.shape[1]) / 2)+ 1 # line/font thickness</span><br><span class="line">	color = color or [random.randint(0, 255) for _ in range(3)]</span><br><span class="line">	c1, c2 = (int(x[0]), int(x[1])), (int(x[2]), int(x[3]))</span><br><span class="line">	cv2.rectangle(img, c1, c2, color, thickness=tl, lineType=cv2.LINE_AA)</span><br><span class="line">	cv2.circle(img, ((c1[0] + c2[0]) // 2, (c1[1] + c2[1]) // 2), 3, (0, 0,</span><br><span class="line">255), thickness=tl)</span><br><span class="line">	# 创建了个中心点坐标变量</span><br><span class="line">	Center = (((c2[0] - c1[0]) / 2 + c1[0]), ((c2[1] - c1[1]) / 2 + c1[1]))</span><br><span class="line">	cv2.putText(img, str(Center), ((c1[0] + c2[0]) // 2, (c1[1] + c2[1]) //2), 0, 0.8, (0, 0, 255), thickness=4, lineType=cv2.LINE_AA)</span><br><span class="line">	print(&quot;左上点的坐标为：(&quot; + str(c1[0]) + &quot;,&quot; + str(c1[1]) + &quot;)，右下点的坐标为(&quot; + str(c2[0]) + &quot;,&quot; +str(c2[1]) + &quot;)&quot;)</span><br><span class="line">	print(&quot;中心点的坐标为：(&quot; + str((c2[0] - c1[0]) / 2 + c1[0]) + &quot;,&quot; +str((c2[1] - c1[1]) / 2 + c1[1]) + &quot;)&quot;)</span><br><span class="line">	#打印左上角和右下角的坐标</span><br><span class="line">if label:</span><br><span class="line">	tf = max(tl - 1, 1) # font thickness</span><br><span class="line">	t_size = cv2.getTextSize(label, 0, fontScale=tl / 3, thickness=tf)[0]</span><br><span class="line">	c2 = c1[0] + t_size[0], c1[1] - t_size[1] - 3</span><br><span class="line">	cv2.rectangle(img, c1, c2, color, -1, cv2.LINE_AA) # filled</span><br><span class="line">	cv2.putText(img, label, (c1[0], c1[1] - 2), 0, tl / 3, [225, 255,255], thickness=tf, lineType=cv2.LINE_AA)</span><br></pre></td></tr></table></figure>
<p>​    此时，在右下角添加pycharm虚拟环境，选择之前创建好的虚拟环境，运行detect.py，此时若出现显示调用摄像头识别框且显示识别框的中心点坐标则说明配置成功。</p>
<h3 id="将文件export。"><a href="#将文件export。" class="headerlink" title="将文件export。"></a>将文件export。</h3><p>​    首先，需要对export文件做出解释：export文件只是一个输出性文件，所输出的相当于只是另一个形式的.pt纯权重文件，因此若要在板载上部署仍需要进行以上基础修改操作：添加onnx权重矩阵地址、修改摄像头端口号及其分辨率、修改plot函数。</p>
<p>​    一般来说，我们为了识别一类物品，需要自己单独训练一个模型，但是我懒OVO，所以我会直接用官方识别几十种label的预权重模型，并加以修改为只输出识别一类物品（如人）。如果有时间的话，下一次研究的时候我再加上训练过程的记录吧。</p>
<p>​    言归正传，我们需要输出能够被树莓派和x3派成功使用，则需要我们修改opset版本号：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">torch.onnx.export(...,opset_version=11,...)#修改为11</span><br></pre></td></tr></table></figure>
<p>​    直接输出即可。</p>
<h1 id="跟踪思路：下位机处理逻辑与源代码"><a href="#跟踪思路：下位机处理逻辑与源代码" class="headerlink" title="跟踪思路：下位机处理逻辑与源代码"></a>跟踪思路：下位机处理逻辑与源代码</h1><p>​    我们从上位机得到输出的只能是一个人物检测框的中心点坐标，我们需要据此将舵机云台进行调整。</p>
<h3 id="坐标系转换"><a href="#坐标系转换" class="headerlink" title="坐标系转换"></a>坐标系转换</h3><p><img src="/2024/10/28/2/坐标系.png" alt></p>
<p>​    为了让云台知道自己该如何旋转，我们需要将其特征转换到一个中央对准的坐标系中去，我们所使用的像素画幅为640*480的矩形。即从识别坐标系opencv转换到旋转判定坐标系中。如果该类物体的坐标在1、2象限，那俯仰舵机向上旋转单位角度并继续获取旋转后坐标再进行比对；若该类物体坐标在2、3象限，那么水平舵机则向左旋转单位角度并继续获取旋转后坐标再进行比对。假设我们设定一个瞄准区域为（-25，25），也即当其旋转至此范围内时，判定为已经瞄准，则停止旋转，如下图所示：</p>
<p>​                <img src="/2024/10/28/2/zuobiaoxi.png" alt> </p>
<p>​    但是若旋转角度不变，则会产生一个问题，那就是：如果单位旋转角度过小，那么瞄准所需要的时间则会很长；如果单位旋转角度过大，那么瞄准所需要的时间虽然很短，但是由于中心瞄准区域的大小不宜太大，很容易造成转过了的情况，从而导致在人物中心点处左右摇摆。因此，针对不同的角度差值，使用不同的单位旋转角度，可以在一定程度上模拟位置式pid的效果——即，差的越远转的越快，差的越近转的越慢。实测跟踪效果会更好。</p>
<p><strong>T.I.P.S 不建议对角度进行惯性滤波，会导致跟随太慢的问题。</strong>（通信频率远小于100HZ）</p>
<p><strong>P.S.在使用之前，我们应当先对舵机进行标定（放在行程的中心点处）再进行安装。</strong></p>
<h3 id="焦距变换-坐标系转换（未验证）"><a href="#焦距变换-坐标系转换（未验证）" class="headerlink" title="焦距变换+坐标系转换（未验证）"></a>焦距变换+坐标系转换（未验证）</h3><p>​    我们可以看出来，上面那种方法麻烦且定位慢，那么为什么我们不能直接一下子就转到想要的角度呢？原因是我们使用的工业USB摄像头属于单目摄像头，一般来说不用单目摄像头进行测距，没有三维空间第三个坐标的信息，我们很难获取直接的坐标。但是，如果我们了解单目摄像头以及YOLO算法识别坐标的本质，那我们也同样能够获得这个三维空间的Z坐标信息。</p>
<p>​    在引脚分配部分，我曾提到要记住摄像头的焦距信息，使用单目摄像机的YOLO算法识别时，世界的影像被投影到一个平行于目前摄像头平面的二维平面上，它们之间的距离则是焦距，此时焦距单位按照像素计算。如下图所示：</p>
<p><img src="/2024/10/28/2/fushitu.png" alt></p>
<p>​    在平视情况下，我们也可以通过该种计算方法来直接旋转到目标转角。</p>
<p>​    <strong>P.S.按照理论来说这种方法很准，但是我个人在使用的时候，实际部署到上位机的时候确实不怎么准确（应该是我把焦距搞错了），没找到特别具体的原因，欢迎一试。</strong></p>
<h3 id="下位机控制代码"><a href="#下位机控制代码" class="headerlink" title="下位机控制代码"></a>下位机控制代码</h3><p>​    基于单纯的坐标系转换方法，使用STM32CUBEIDE编写和配置下位机。经过配置和引脚分配，配置如下图所示：</p>
<p>​    总体引脚:</p>
<p><img src="/2024/10/28/2/1.png" alt></p>
<p>​    时钟树：</p>
<p><img src="/2024/10/28/2/2.png" alt></p>
<p>PWM波：</p>
<p><img src="/2024/10/28/2/3.png" alt></p>
<p>烧录与通讯口：（usart3未使用）</p>
<p><img src="/2024/10/28/2/4.png" alt></p>
<p>使用最简单方案：坐标转换法</p>
<p>这里只对部分代码进行解析：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">int x1=changebuff[0]*100+changebuff[1]*10+changebuff[2];</span><br><span class="line">int y1=changebuff[3]*100+changebuff[4]*10+changebuff[5];</span><br><span class="line">int x=changebuff[0]*100+changebuff[1]*10+changebuff[2]-320;</span><br><span class="line">int y=-(changebuff[3]*100+changebuff[4]*10+changebuff[5]-240);</span><br><span class="line">//从缓冲区读取并将坐标转换为中心坐标系</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">int quadrant;//判断坐标系</span><br><span class="line">if(x&gt;0&amp;&amp;y&gt;0)</span><br><span class="line">&#123;</span><br><span class="line">	quadrant=1;</span><br><span class="line">&#125;</span><br><span class="line">else if(x&lt;0&amp;&amp;y&gt;0)</span><br><span class="line">&#123;</span><br><span class="line">    quadrant=2;</span><br><span class="line">&#125;</span><br><span class="line">else if(x&lt;0&amp;&amp;y&lt;0)</span><br><span class="line">&#123;</span><br><span class="line">    quadrant=3;</span><br><span class="line">&#125;</span><br><span class="line">else if(x&gt;0&amp;&amp;y&lt;0)</span><br><span class="line">&#123;</span><br><span class="line">    quadrant=4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">//控制左右旋转，确定当x在正负50以内为锁定成功，当其远不在锁定范围内时，移动步长为5，当其小于120时，移动步长为1，精确锁定。</span><br><span class="line">      int change_angle=5;</span><br><span class="line">	  int change_angle1=1;</span><br><span class="line">	  int range_max=100;</span><br><span class="line">	  int range_min=50;</span><br><span class="line">	  if(abs(x)&gt;50)</span><br><span class="line">	  &#123;</span><br><span class="line">	   if(abs(x)&gt;120)</span><br><span class="line">	   &#123;</span><br><span class="line">	   if(quadrant==1||quadrant==4)</span><br><span class="line">	     &#123;</span><br><span class="line">	       orgin1=orgin1-change_angle;</span><br><span class="line">	       if(orgin1&gt;=180)</span><br><span class="line">	       &#123;</span><br><span class="line">	    	   orgin1=180;</span><br><span class="line">	       &#125;</span><br><span class="line">	       if(orgin1&lt;5)</span><br><span class="line">	       &#123;</span><br><span class="line">	      	   orgin1=5;</span><br><span class="line">	       &#125;</span><br><span class="line">	       servo_angle_left_right(orgin1);</span><br><span class="line">	     &#125;</span><br><span class="line">	   if(quadrant==2||quadrant==3)</span><br><span class="line">	     &#123;</span><br><span class="line">	       orgin1=orgin1+change_angle;</span><br><span class="line">	       if(orgin1&gt;=180)</span><br><span class="line">	       &#123;</span><br><span class="line">	       	   orgin1=180;</span><br><span class="line">	       &#125;</span><br><span class="line">	       if(orgin1&lt;5)</span><br><span class="line">	       &#123;</span><br><span class="line">	       	   orgin1=5;</span><br><span class="line">	       &#125;</span><br><span class="line">	       servo_angle_left_right(orgin1);</span><br><span class="line">	     &#125;</span><br><span class="line">	   if(quadrant==1||quadrant==2)</span><br><span class="line">	     &#123;</span><br><span class="line">	       orgin2=orgin2+change_angle;																																																		change_angle;</span><br><span class="line">	       if(orgin2&gt;=180)</span><br><span class="line">		 &#123;</span><br><span class="line">			   orgin2=180;</span><br><span class="line">	     &#125;</span><br><span class="line">		   if(orgin2&lt;5)</span><br><span class="line">		 &#123;</span><br><span class="line">			   orgin2=5;</span><br><span class="line">		 &#125;</span><br><span class="line">	       //servo_angle_up_down(orgin2);</span><br><span class="line">	     &#125;</span><br><span class="line">	   if(quadrant==3||quadrant==4)</span><br><span class="line">	     &#123;</span><br><span class="line">	       orgin2=orgin2-change_angle;</span><br><span class="line">	       if(orgin2&gt;=180)</span><br><span class="line">	     &#123;</span><br><span class="line">			   orgin2=180;</span><br><span class="line">	     &#125;</span><br><span class="line">		   if(orgin2&lt;5)</span><br><span class="line">	     &#123;</span><br><span class="line">			   orgin2=5;</span><br><span class="line">	     &#125;</span><br><span class="line">	       //servo_angle_up_down(orgin2);</span><br><span class="line">	     &#125;</span><br><span class="line">	   &#125;</span><br><span class="line">	   else</span><br><span class="line">	   &#123;</span><br><span class="line">		   if(quadrant==1||quadrant==4)</span><br><span class="line">		   	     &#123;</span><br><span class="line">		   	       orgin1=orgin1-change_angle1;</span><br><span class="line">		   	       if(orgin1&gt;=180)</span><br><span class="line">		   	       &#123;</span><br><span class="line">		   	    	   orgin1=180;</span><br><span class="line">		   	       &#125;</span><br><span class="line">		   	       if(orgin1&lt;5)</span><br><span class="line">		   	       &#123;</span><br><span class="line">		   	      	   orgin1=5;</span><br><span class="line">		   	       &#125;</span><br><span class="line">		   	       servo_angle_left_right(orgin1);</span><br><span class="line">		   	     &#125;</span><br><span class="line">		   	   if(quadrant==2||quadrant==3)</span><br><span class="line">		   	     &#123;</span><br><span class="line">		   	       orgin1=orgin1+change_angle1;</span><br><span class="line">		   	       if(orgin1&gt;=180)</span><br><span class="line">		   	       &#123;</span><br><span class="line">		   	       	   orgin1=180;</span><br><span class="line">		   	       &#125;</span><br><span class="line">		   	       if(orgin1&lt;5)</span><br><span class="line">		   	       &#123;</span><br><span class="line">		   	       	   orgin1=5;</span><br><span class="line">		   	       &#125;</span><br><span class="line">		   	       servo_angle_left_right(orgin1);</span><br><span class="line">		   	     &#125;</span><br><span class="line">	   &#125;</span><br><span class="line"></span><br><span class="line">	  &#125;</span><br></pre></td></tr></table></figure>
<h1 id="在树莓派（地平线X3派）中使用yolov5算法（fcos目标检测算法）。"><a href="#在树莓派（地平线X3派）中使用yolov5算法（fcos目标检测算法）。" class="headerlink" title="在树莓派（地平线X3派）中使用yolov5算法（fcos目标检测算法）。"></a>在树莓派（地平线X3派）中使用yolov5算法（fcos目标检测算法）。</h1><p>地平线X3派中已经部署完毕，有机会再补充这部分部署代码（官方代码抄录）；</p>
<p>树莓派中部署：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line">import cv2</span><br><span class="line">import numpy as np</span><br><span class="line">import onnxruntime as ort</span><br><span class="line">import time</span><br><span class="line"> </span><br><span class="line">def plot_one_box(x, img, color=None, label=None, line_thickness=None):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    description: Plots one bounding box on image img,</span><br><span class="line">                 this function comes from YoLov5 project.</span><br><span class="line">    param: </span><br><span class="line">        x:      a box likes [x1,y1,x2,y2]</span><br><span class="line">        img:    a opencv image object</span><br><span class="line">        color:  color to draw rectangle, such as (0,255,0)</span><br><span class="line">        label:  str</span><br><span class="line">        line_thickness: int</span><br><span class="line">    return:</span><br><span class="line">        no return</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    tl = (</span><br><span class="line">        line_thickness or round(0.002 * (img.shape[0] + img.shape[1]) / 2) + 1</span><br><span class="line">    )  # line/font thickness</span><br><span class="line">    color = color or [random.randint(0, 255) for _ in range(3)]</span><br><span class="line">    c1, c2 = (int(x[0]), int(x[1])), (int(x[2]), int(x[3]))</span><br><span class="line">    cv2.rectangle(img, c1, c2, color, thickness=tl, lineType=cv2.LINE_AA)</span><br><span class="line">    if label:</span><br><span class="line">        tf = max(tl - 1, 1)  # font thickness</span><br><span class="line">        t_size = cv2.getTextSize(label, 0, fontScale=tl / 3, thickness=tf)[0]</span><br><span class="line">        c2 = c1[0] + t_size[0], c1[1] - t_size[1] - 3</span><br><span class="line">        cv2.rectangle(img, c1, c2, color, -1, cv2.LINE_AA)  # filled</span><br><span class="line">        cv2.putText(</span><br><span class="line">            img,</span><br><span class="line">            label,</span><br><span class="line">            (c1[0], c1[1] - 2),</span><br><span class="line">            0,</span><br><span class="line">            tl / 3,</span><br><span class="line">            [225, 255, 255],</span><br><span class="line">            thickness=tf,</span><br><span class="line">            lineType=cv2.LINE_AA,</span><br><span class="line">        )</span><br><span class="line"> </span><br><span class="line">def _make_grid( nx, ny):</span><br><span class="line">        xv, yv = np.meshgrid(np.arange(ny), np.arange(nx))</span><br><span class="line">        return np.stack((xv, yv), 2).reshape((-1, 2)).astype(np.float32)</span><br><span class="line"> </span><br><span class="line">def cal_outputs(outs,nl,na,model_w,model_h,anchor_grid,stride):</span><br><span class="line">    </span><br><span class="line">    row_ind = 0</span><br><span class="line">    grid = [np.zeros(1)] * nl</span><br><span class="line">    for i in range(nl):</span><br><span class="line">        h, w = int(model_w/ stride[i]), int(model_h / stride[i])</span><br><span class="line">        length = int(na * h * w)</span><br><span class="line">        if grid[i].shape[2:4] != (h, w):</span><br><span class="line">            grid[i] = _make_grid(w, h)</span><br><span class="line"> </span><br><span class="line">        outs[row_ind:row_ind + length, 0:2] = (outs[row_ind:row_ind + length, 0:2] * 2. - 0.5 + np.tile(</span><br><span class="line">            grid[i], (na, 1))) * int(stride[i])</span><br><span class="line">        outs[row_ind:row_ind + length, 2:4] = (outs[row_ind:row_ind + length, 2:4] * 2) ** 2 * np.repeat(</span><br><span class="line">            anchor_grid[i], h * w, axis=0)</span><br><span class="line">        row_ind += length</span><br><span class="line">    return outs</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">def post_process_opencv(outputs,model_h,model_w,img_h,img_w,thred_nms,thred_cond):</span><br><span class="line">    conf = outputs[:,4].tolist()</span><br><span class="line">    c_x = outputs[:,0]/model_w*img_w</span><br><span class="line">    c_y = outputs[:,1]/model_h*img_h</span><br><span class="line">    w  = outputs[:,2]/model_w*img_w</span><br><span class="line">    h  = outputs[:,3]/model_h*img_h</span><br><span class="line">    p_cls = outputs[:,5:]</span><br><span class="line">    if len(p_cls.shape)==1:</span><br><span class="line">        p_cls = np.expand_dims(p_cls,1)</span><br><span class="line">    cls_id = np.argmax(p_cls,axis=1)</span><br><span class="line"> </span><br><span class="line">    p_x1 = np.expand_dims(c_x-w/2,-1)</span><br><span class="line">    p_y1 = np.expand_dims(c_y-h/2,-1)</span><br><span class="line">    p_x2 = np.expand_dims(c_x+w/2,-1)</span><br><span class="line">    p_y2 = np.expand_dims(c_y+h/2,-1)</span><br><span class="line">    areas = np.concatenate((p_x1,p_y1,p_x2,p_y2),axis=-1)</span><br><span class="line">    </span><br><span class="line">    areas = areas.tolist()</span><br><span class="line">    ids = cv2.dnn.NMSBoxes(areas,conf,thred_cond,thred_nms)</span><br><span class="line">    if len(ids)&gt;0:</span><br><span class="line">        return  np.array(areas)[ids],np.array(conf)[ids],cls_id[ids]</span><br><span class="line">    else:</span><br><span class="line">        return [],[],[]</span><br><span class="line">def infer_img(img0,net,model_h,model_w,nl,na,stride,anchor_grid,thred_nms=0.4,thred_cond=0.5):</span><br><span class="line">    # 图像预处理</span><br><span class="line">    img = cv2.resize(img0, [model_w,model_h], interpolation=cv2.INTER_AREA)</span><br><span class="line">    img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)</span><br><span class="line">    img = img.astype(np.float32) / 255.0</span><br><span class="line">    blob = np.expand_dims(np.transpose(img, (2, 0, 1)), axis=0)</span><br><span class="line"> </span><br><span class="line">    # 模型推理</span><br><span class="line">    outs = net.run(None, &#123;net.get_inputs()[0].name: blob&#125;)[0].squeeze(axis=0)</span><br><span class="line"> </span><br><span class="line">    # 输出坐标矫正</span><br><span class="line">    outs = cal_outputs(outs,nl,na,model_w,model_h,anchor_grid,stride)</span><br><span class="line"> </span><br><span class="line">    # 检测框计算</span><br><span class="line">    img_h,img_w,_ = np.shape(img0)</span><br><span class="line">    boxes,confs,ids = post_process_opencv(outs,model_h,model_w,img_h,img_w,thred_nms,thred_cond)</span><br><span class="line"> </span><br><span class="line">    return  boxes,confs,ids</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line"> </span><br><span class="line">    # 模型加载切换为自己的权重矩阵</span><br><span class="line">    model_pb_path = &quot;best.onnx&quot;</span><br><span class="line">    so = ort.SessionOptions()</span><br><span class="line">    net = ort.InferenceSession(model_pb_path, so)</span><br><span class="line">    </span><br><span class="line">    # 标签字典，切换为官方的字典，并且修改为只检测一类</span><br><span class="line">    dic_labels= &#123;0:&#x27;drug&#x27;,</span><br><span class="line">            1:&#x27;glue&#x27;,</span><br><span class="line">            2:&#x27;prime&#x27;&#125;</span><br><span class="line">    </span><br><span class="line">    # 模型参数</span><br><span class="line">    model_h = 320</span><br><span class="line">    model_w = 320</span><br><span class="line">    nl = 3</span><br><span class="line">    na = 3</span><br><span class="line">    stride=[8.,16.,32.]</span><br><span class="line">    anchors = [[10, 13, 16, 30, 33, 23], [30, 61, 62, 45, 59, 119], [116, 90, 156, 198, 373, 326]]</span><br><span class="line">    anchor_grid = np.asarray(anchors, dtype=np.float32).reshape(nl, -1, 2)</span><br><span class="line">    </span><br><span class="line">    video = 0</span><br><span class="line">    cap = cv2.VideoCapture(video)</span><br><span class="line">    flag_det = False</span><br><span class="line">    while True:</span><br><span class="line">        success, img0 = cap.read()</span><br><span class="line">        if success:</span><br><span class="line">            </span><br><span class="line">            if flag_det:</span><br><span class="line">                t1 = time.time()</span><br><span class="line">                det_boxes,scores,ids = infer_img(img0,net,model_h,model_w,nl,na,stride,anchor_grid,thred_nms=0.4,thred_cond=0.5)</span><br><span class="line">                t2 = time.time()</span><br><span class="line">            </span><br><span class="line">                </span><br><span class="line">                for box,score,id in zip(det_boxes,scores,ids):</span><br><span class="line">                    label = &#x27;%s:%.2f&#x27;%(dic_labels[id],score)</span><br><span class="line">            </span><br><span class="line">                    plot_one_box(box.astype(np.int16), img0, color=(255,0,0), label=label, line_thickness=None)</span><br><span class="line">                    </span><br><span class="line">                str_FPS = &quot;FPS: %.2f&quot;%(1./(t2-t1))</span><br><span class="line">                </span><br><span class="line">                cv2.putText(img0,str_FPS,(50,50),cv2.FONT_HERSHEY_COMPLEX,1,(0,255,0),3)</span><br><span class="line">                </span><br><span class="line">            </span><br><span class="line">            cv2.imshow(&quot;video&quot;,img0)</span><br><span class="line">        key=cv2.waitKey(1) &amp; 0xFF    </span><br><span class="line">        if key == ord(&#x27;q&#x27;):</span><br><span class="line">        </span><br><span class="line">            break</span><br><span class="line">        elif key &amp; 0xFF == ord(&#x27;s&#x27;):</span><br><span class="line">            flag_det = not flag_det</span><br><span class="line">            print(flag_det)</span><br><span class="line">            </span><br><span class="line">    cap.release() </span><br></pre></td></tr></table></figure>
<h1 id="地平线x3派与下位机通讯。"><a href="#地平线x3派与下位机通讯。" class="headerlink" title="地平线x3派与下位机通讯。"></a>地平线x3派与下位机通讯。</h1><p>基于以上部署，我们做出以下修改：</p>
<p>首先修改为自己权重矩阵的绝对路径和字典库罗列。</p>
<p>修改为只检测一类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if label == &#x27;person&#x27;</span><br><span class="line">	 plot_one_box(box.astype(np.int16), img0, color=(255,0,0), label=label, line_thickness=None)</span><br><span class="line">                    </span><br><span class="line">                str_FPS = &quot;FPS: %.2f&quot;%(1./(t2-t1))</span><br><span class="line">                </span><br><span class="line">                cv2.putText(img0,str_FPS,(50,50),cv2.FONT_HERSHEY_COMPLEX,1,(0,255,0),3)</span><br><span class="line">                </span><br><span class="line">            </span><br><span class="line">            cv2.imshow(&quot;video&quot;,img0)</span><br></pre></td></tr></table></figure>
<p><strong>[warning]此种方法依然检测了多种类，只是只显示和输出了一类结果，实时性有待提高，还是应该自己训练为最佳。</strong></p>
<p>若实现通讯，上位机应该在plot中加入修改以下内容（以YOLO为例）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">#修改plots.py中plot_one_box内容</span><br><span class="line">def plot_one_box(x, img, color=None, label=None, line_thickness=3):</span><br><span class="line">    # Plots one bounding box on image img</span><br><span class="line">    tl = line_thickness or round(0.002 * (img.shape[0] + img.shape[1]) / 2) + 1  # line/font thickness</span><br><span class="line">    color = color or [random.randint(0, 255) for _ in range(3)]</span><br><span class="line">    c1, c2 = (int(x[0]), int(x[1])), (int(x[2]), int(x[3]))</span><br><span class="line">    cv2.rectangle(img, c1, c2, color, thickness=tl, lineType=cv2.LINE_AA)</span><br><span class="line">    cv2.circle(img, ((c1[0] + c2[0]) // 2, (c1[1] + c2[1]) // 2), 3, (0, 0, 255), thickness=tl)</span><br><span class="line">    # 创建了个中心点坐标变量</span><br><span class="line">    Center = (((c2[0] - c1[0]) / 2 + c1[0]), ((c2[1] - c1[1]) / 2 + c1[1]))</span><br><span class="line">    cv2.putText(img, str(Center), ((c1[0] + c2[0]) // 2, (c1[1] + c2[1]) // 2), 0, 0.8, (0, 0, 255),  thickness=4, lineType=cv2.LINE_AA)</span><br><span class="line">    #print(&quot;左上点的坐标为：(&quot; + str(c1[0]) + &quot;,&quot; + str(c1[1]) + &quot;)，右下点的坐标为(&quot; + str(c2[0]) + &quot;,&quot; + str(c2[1]) + &quot;)&quot;)</span><br><span class="line">    #print(str(int((c2[0] - c1[0]) / 2) + c1[0])+str(int((c2[1] - c1[1]) / 2) + c1[1]))</span><br><span class="line">    ##ser = serial.Serial(&#x27;COM6&#x27;, 115200, timeout=1)  # &#x27;COM5&#x27;是你的串口号，115200是波特率，timeout是超时时间（单位为秒）</span><br><span class="line">    ##if ser.is_open:</span><br><span class="line">    ##   print(&quot;串口已打开&quot;)</span><br><span class="line">    if 10&lt;=Center[0]&lt;100:</span><br><span class="line">        #print(str(0)+str(int(Center[0])) + str(int(Center[1])))</span><br><span class="line">        str2=str(0)+str(int(Center[0])) + str(int(Center[1]))</span><br><span class="line">        #encoded_str = str2.encode(&#x27;utf-8&#x27;)</span><br><span class="line">        ##    send_data_hex = bytes.fromhex(str2)</span><br><span class="line">        ##   ser.write(send_data_hex)</span><br><span class="line">        sleep(0.1)</span><br><span class="line">        ##   data=ser.read_all().hex()</span><br><span class="line">        ##   print(data)</span><br><span class="line"></span><br><span class="line">    if Center[0]&lt;10:</span><br><span class="line">        #print(str(0)+str(0) + str(int(Center[0])) + str(int(Center[1])))</span><br><span class="line">        str2 = str(0)+str(0) + str(int(Center[0])) + str(int(Center[1]))</span><br><span class="line">        #encoded_str = str2.encode(&#x27;utf-8&#x27;)</span><br><span class="line">        send_data_hex = bytes.fromhex(str2)</span><br><span class="line">        ##   ser.write(send_data_hex)</span><br><span class="line">        sleep(0.1)</span><br><span class="line">        ##  data = ser.read_all().hex()</span><br><span class="line">        ##    print(data)</span><br><span class="line"></span><br><span class="line">    if 10&lt;=Center[1]&lt;100:</span><br><span class="line">        #print(str(int(Center[0])) + str(0)+str(int(Center[1])))</span><br><span class="line">        str2 = str(int(Center[0])) + str(0)+str(int(Center[1]))</span><br><span class="line">        #encoded_str = str2.encode(&#x27;utf-8&#x27;)</span><br><span class="line">        send_data_hex = bytes.fromhex(str2)</span><br><span class="line">    ##   ser.write(send_data_hex)</span><br><span class="line">    sleep(0.1)</span><br><span class="line">    ##   data = ser.read_all().hex()</span><br><span class="line">    ##  print(data)</span><br><span class="line"></span><br><span class="line">if Center[1]&lt;10:</span><br><span class="line">    #print(str(int(Center[0])) + str(0)+str(0)+str(int(Center[1])))</span><br><span class="line">    str2 = str(int(Center[0])) + str(0)+str(0)+str(int(Center[1]))</span><br><span class="line">    #encoded_str = str2.encode(&#x27;utf-8&#x27;)</span><br><span class="line">    ##   send_data_hex = bytes.fromhex(str2)</span><br><span class="line">    ##   ser.write(send_data_hex)</span><br><span class="line">    sleep(0.1)</span><br><span class="line">    ##   data = ser.read_all().hex()</span><br><span class="line">    ##  print(data)</span><br><span class="line"></span><br><span class="line">if Center[0]&gt;100 and Center[1]&gt;100:</span><br><span class="line">    print(str(int(Center[0])) + str(int(Center[1])))</span><br><span class="line">    str2 = str(int(Center[0])) + str(int(Center[1]))</span><br><span class="line">    #print(str2)</span><br><span class="line">    #encoded_str = str2.encode(&#x27;utf-8&#x27;)</span><br><span class="line">    ##  send_data_hex = bytes.fromhex(str2)</span><br><span class="line">    ##  ser.write(send_data_hex)</span><br><span class="line">    sleep(0.1)</span><br><span class="line">    ##  data = ser.read_all()</span><br><span class="line">   # print(data)</span><br><span class="line">##  data1 = data.hex()</span><br><span class="line">    ##  print(data1)</span><br><span class="line"></span><br><span class="line">if label:</span><br><span class="line">    tf = max(tl - 1, 1)  # font thickness</span><br><span class="line">    t_size = cv2.getTextSize(label, 0, fontScale=tl / 3, thickness=tf)[0]</span><br><span class="line">    c2 = c1[0] + t_size[0], c1[1] - t_size[1] - 3</span><br><span class="line">    cv2.rectangle(img, c1, c2, color, -1, cv2.LINE_AA)  # filled</span><br><span class="line">    cv2.putText(img, label, (c1[0], c1[1] - 2), 0, tl / 3, [225, 255, 255], thickness=tf, lineType=cv2.LINE_AA)</span><br></pre></td></tr></table></figure>
<p>因为是使用十六进制传递坐标信息，因此下位机应该将所传输的十六进制ASCII码值解码，如下图所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">HAL_UART_Receive(&amp;huart3,buff,3,HAL_MAX_DELAY);</span><br><span class="line">HAL_UART_Transmit(&amp;huart3,buff,3,HAL_MAX_DELAY);</span><br><span class="line">intbuff[0]=buff[0];</span><br><span class="line">intbuff[1]=buff[1];</span><br><span class="line">intbuff[2]=buff[2];</span><br><span class="line">intbuff[0]=floor(intbuff[0]/16)*10+intbuff[0]%16;</span><br><span class="line">intbuff[1]=floor(intbuff[1]/16)*10+intbuff[1]%16;</span><br><span class="line">intbuff[2]=floor(intbuff[2]/16)*10+intbuff[2]%16;</span><br><span class="line">changebuff[0]=floor(intbuff[0]/10);</span><br><span class="line">changebuff[1]=intbuff[0]-changebuff[0]*10;</span><br><span class="line">changebuff[2]=floor(intbuff[1]/10);</span><br><span class="line">changebuff[3]=intbuff[1]-changebuff[2]*10;</span><br><span class="line">changebuff[4]=floor(intbuff[2]/10);</span><br><span class="line">changebuff[5]=intbuff[2]-changebuff[4]*10;</span><br></pre></td></tr></table></figure>
<h1 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h1><p>训练过程：遥遥无期ing</p>
<p>下位机使用CUBEIDE配置，全部代码已经开源至git仓库：<a target="_blank" rel="noopener" href="https://github.com/SAINT784167/YOLO-LOW-CONTORL">https://github.com/SAINT784167/YOLO-LOW-CONTORL</a></p>
<h2 id="补充x3派使用过程："><a href="#补充x3派使用过程：" class="headerlink" title="补充x3派使用过程："></a>补充x3派使用过程：</h2><h3 id="制作好启动盘"><a href="#制作好启动盘" class="headerlink" title="制作好启动盘"></a>制作好启动盘</h3><p>将下载的img文件烧录至TF卡中</p>
<p><img src="/2024/10/28/2/11.png" alt></p>
<h3 id="更改自己电脑至静态IP地址"><a href="#更改自己电脑至静态IP地址" class="headerlink" title="更改自己电脑至静态IP地址"></a>更改自己电脑至静态IP地址</h3><p>烧录版本&gt;=2.1.0因此个人电脑作为主机ip为192.168.127.100，此时从机地址为192.168.127.10，从cmdping地址可以看到其是否已经连接上。</p>
<p><img src="/2024/10/28/2/33.png" alt></p>
<p><img src="/2024/10/28/2/22.png" alt></p>
<h3 id="使用命令行格式打开系统并进行基础配置。"><a href="#使用命令行格式打开系统并进行基础配置。" class="headerlink" title="使用命令行格式打开系统并进行基础配置。"></a>使用命令行格式打开系统并进行基础配置。</h3><p>打开PUTTY软件，输入192.168.127.10，输入open，此时，需要我们登录ssh，用户名密码如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">用户名：sunrise</span><br><span class="line">密码：sunrise</span><br></pre></td></tr></table></figure>
<p>输入系统基础配置命令，来到命令行页面，进入<code>Interface Options</code>并启用VNC服务。</p>
<p><img src="/2024/10/28/2/44.png" alt></p>
<p>输入<code>vncserver</code>命令，开启vncserver，此时，打开软件VNCviewer,在搜索栏中输入<code>192.168.127.10</code>，并输入密码<code>sunrise</code>进入ubuntu界面。</p>
<p><img src="/2024/10/28/2/55.png" alt></p>
<p><img src="/2024/10/28/2/66.png" alt></p>
<h3 id="进入系统页面并查看配置好的fcos的python列表并进行修改，查看摄像头链接情况"><a href="#进入系统页面并查看配置好的fcos的python列表并进行修改，查看摄像头链接情况" class="headerlink" title="进入系统页面并查看配置好的fcos的python列表并进行修改，查看摄像头链接情况"></a>进入系统页面并查看配置好的fcos的python列表并进行修改，查看摄像头链接情况</h3><p>连接上usb摄像头，查看摄像头端口号以看其是否正常连接，使用<code>ctrl+alt+T</code>新建终端我们在插拔时分别输入<code>sudo lsusb</code>显示usb设备如下图所示：</p>
<p><img src="/2024/10/28/2/blog/source/_posts/╩╙╛⌡/2/77.png" alt></p>
<p>补，留档，2.1.0版本fcos部署源代码,已改为640*480：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> hobot_dnn <span class="keyword">import</span> pyeasy_dnn <span class="keyword">as</span> dnn</span><br><span class="line"><span class="keyword">from</span> hobot_vio <span class="keyword">import</span> libsrcampy <span class="keyword">as</span> srcampy</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> colorsys</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">import</span> json </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">signal_handler</span>(<span class="params">signal, frame</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nExiting program&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">output_tensors = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">fcos_postprocess_info = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">hbSysMem_t</span>(ctypes.Structure):</span><br><span class="line">    _fields_ = [</span><br><span class="line">        (<span class="string">&quot;phyAddr&quot;</span>,ctypes.c_double),</span><br><span class="line">        (<span class="string">&quot;virAddr&quot;</span>,ctypes.c_void_p),</span><br><span class="line">        (<span class="string">&quot;memSize&quot;</span>,ctypes.c_int)</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">hbDNNQuantiShift_yt</span>(ctypes.Structure):</span><br><span class="line">    _fields_ = [</span><br><span class="line">        (<span class="string">&quot;shiftLen&quot;</span>,ctypes.c_int),</span><br><span class="line">        (<span class="string">&quot;shiftData&quot;</span>,ctypes.c_char_p)</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">hbDNNQuantiScale_t</span>(ctypes.Structure):</span><br><span class="line">    _fields_ = [</span><br><span class="line">        (<span class="string">&quot;scaleLen&quot;</span>,ctypes.c_int),</span><br><span class="line">        (<span class="string">&quot;scaleData&quot;</span>,ctypes.POINTER(ctypes.c_float)),</span><br><span class="line">        (<span class="string">&quot;zeroPointLen&quot;</span>,ctypes.c_int),</span><br><span class="line">        (<span class="string">&quot;zeroPointData&quot;</span>,ctypes.c_char_p)</span><br><span class="line">    ]    </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">hbDNNTensorShape_t</span>(ctypes.Structure):</span><br><span class="line">    _fields_ = [</span><br><span class="line">        (<span class="string">&quot;dimensionSize&quot;</span>,ctypes.c_int * <span class="number">8</span>),</span><br><span class="line">        (<span class="string">&quot;numDimensions&quot;</span>,ctypes.c_int)</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">hbDNNTensorProperties_t</span>(ctypes.Structure):</span><br><span class="line">    _fields_ = [</span><br><span class="line">        (<span class="string">&quot;validShape&quot;</span>,hbDNNTensorShape_t),</span><br><span class="line">        (<span class="string">&quot;alignedShape&quot;</span>,hbDNNTensorShape_t),</span><br><span class="line">        (<span class="string">&quot;tensorLayout&quot;</span>,ctypes.c_int),</span><br><span class="line">        (<span class="string">&quot;tensorType&quot;</span>,ctypes.c_int),</span><br><span class="line">        (<span class="string">&quot;shift&quot;</span>,hbDNNQuantiShift_yt),</span><br><span class="line">        (<span class="string">&quot;scale&quot;</span>,hbDNNQuantiScale_t),</span><br><span class="line">        (<span class="string">&quot;quantiType&quot;</span>,ctypes.c_int),</span><br><span class="line">        (<span class="string">&quot;quantizeAxis&quot;</span>, ctypes.c_int),</span><br><span class="line">        (<span class="string">&quot;alignedByteSize&quot;</span>,ctypes.c_int),</span><br><span class="line">        (<span class="string">&quot;stride&quot;</span>,ctypes.c_int * <span class="number">8</span>)</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">hbDNNTensor_t</span>(ctypes.Structure):</span><br><span class="line">    _fields_ = [</span><br><span class="line">        (<span class="string">&quot;sysMem&quot;</span>,hbSysMem_t * <span class="number">4</span>),</span><br><span class="line">        (<span class="string">&quot;properties&quot;</span>,hbDNNTensorProperties_t)</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FcosPostProcessInfo_t</span>(ctypes.Structure):</span><br><span class="line">    _fields_ = [</span><br><span class="line">        (<span class="string">&quot;height&quot;</span>,ctypes.c_int),</span><br><span class="line">        (<span class="string">&quot;width&quot;</span>,ctypes.c_int),</span><br><span class="line">        (<span class="string">&quot;ori_height&quot;</span>,ctypes.c_int),</span><br><span class="line">        (<span class="string">&quot;ori_width&quot;</span>,ctypes.c_int),</span><br><span class="line">        (<span class="string">&quot;score_threshold&quot;</span>,ctypes.c_float),</span><br><span class="line">        (<span class="string">&quot;nms_threshold&quot;</span>,ctypes.c_float),</span><br><span class="line">        (<span class="string">&quot;nms_top_k&quot;</span>,ctypes.c_int),</span><br><span class="line">        (<span class="string">&quot;is_pad_resize&quot;</span>,ctypes.c_int)</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">libpostprocess = ctypes.CDLL(<span class="string">&#x27;/usr/lib/libpostprocess.so&#x27;</span>) </span><br><span class="line"></span><br><span class="line">get_Postprocess_result = libpostprocess.FcosPostProcess</span><br><span class="line">get_Postprocess_result.argtypes = [ctypes.POINTER(FcosPostProcessInfo_t)]  </span><br><span class="line">get_Postprocess_result.restype = ctypes.c_char_p  </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_TensorLayout</span>(<span class="params">Layout</span>):</span><br><span class="line">    <span class="keyword">if</span> Layout == <span class="string">&quot;NCHW&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">limit_display_cord</span>(<span class="params">coor</span>):</span><br><span class="line">    coor[<span class="number">0</span>] = <span class="built_in">max</span>(<span class="built_in">min</span>(<span class="number">640</span>, coor[<span class="number">0</span>]), <span class="number">0</span>)</span><br><span class="line">    <span class="comment"># min coor is set to 2 not 0, leaving room for string display</span></span><br><span class="line">    coor[<span class="number">1</span>] = <span class="built_in">max</span>(<span class="built_in">min</span>(<span class="number">480</span>, coor[<span class="number">1</span>]), <span class="number">2</span>)</span><br><span class="line">    coor[<span class="number">2</span>] = <span class="built_in">max</span>(<span class="built_in">min</span>(<span class="number">640</span>, coor[<span class="number">2</span>]), <span class="number">0</span>)</span><br><span class="line">    coor[<span class="number">3</span>] = <span class="built_in">max</span>(<span class="built_in">min</span>(<span class="number">480</span>, coor[<span class="number">3</span>]), <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> coor</span><br><span class="line"></span><br><span class="line"><span class="comment"># detection model class names</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_classes</span>():</span><br><span class="line">    <span class="keyword">return</span> np.array([<span class="string">&quot;person&quot;</span>, <span class="string">&quot;bicycle&quot;</span>, <span class="string">&quot;car&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;motorcycle&quot;</span>, <span class="string">&quot;airplane&quot;</span>, <span class="string">&quot;bus&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;train&quot;</span>, <span class="string">&quot;truck&quot;</span>, <span class="string">&quot;boat&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;traffic light&quot;</span>, <span class="string">&quot;fire hydrant&quot;</span>, <span class="string">&quot;stop sign&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;parking meter&quot;</span>, <span class="string">&quot;bench&quot;</span>, <span class="string">&quot;bird&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;cat&quot;</span>, <span class="string">&quot;dog&quot;</span>, <span class="string">&quot;horse&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;sheep&quot;</span>, <span class="string">&quot;cow&quot;</span>, <span class="string">&quot;elephant&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;bear&quot;</span>, <span class="string">&quot;zebra&quot;</span>, <span class="string">&quot;giraffe&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;backpack&quot;</span>, <span class="string">&quot;umbrella&quot;</span>, <span class="string">&quot;handbag&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;tie&quot;</span>, <span class="string">&quot;suitcase&quot;</span>, <span class="string">&quot;frisbee&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;skis&quot;</span>, <span class="string">&quot;snowboard&quot;</span>, <span class="string">&quot;sports ball&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;kite&quot;</span>, <span class="string">&quot;baseball bat&quot;</span>, <span class="string">&quot;baseball glove&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;skateboard&quot;</span>, <span class="string">&quot;surfboard&quot;</span>, <span class="string">&quot;tennis racket&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;bottle&quot;</span>, <span class="string">&quot;wine glass&quot;</span>, <span class="string">&quot;cup&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;fork&quot;</span>, <span class="string">&quot;knife&quot;</span>, <span class="string">&quot;spoon&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;bowl&quot;</span>, <span class="string">&quot;banana&quot;</span>, <span class="string">&quot;apple&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;sandwich&quot;</span>, <span class="string">&quot;orange&quot;</span>, <span class="string">&quot;broccoli&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;carrot&quot;</span>, <span class="string">&quot;hot dog&quot;</span>, <span class="string">&quot;pizza&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;donut&quot;</span>, <span class="string">&quot;cake&quot;</span>, <span class="string">&quot;chair&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;couch&quot;</span>, <span class="string">&quot;potted plant&quot;</span>, <span class="string">&quot;bed&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;dining table&quot;</span>, <span class="string">&quot;toilet&quot;</span>, <span class="string">&quot;tv&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;laptop&quot;</span>, <span class="string">&quot;mouse&quot;</span>, <span class="string">&quot;remote&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;keyboard&quot;</span>, <span class="string">&quot;cell phone&quot;</span>, <span class="string">&quot;microwave&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;oven&quot;</span>, <span class="string">&quot;toaster&quot;</span>, <span class="string">&quot;sink&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;refrigerator&quot;</span>, <span class="string">&quot;book&quot;</span>, <span class="string">&quot;clock&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;vase&quot;</span>, <span class="string">&quot;scissors&quot;</span>, <span class="string">&quot;teddy bear&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;hair drier&quot;</span>, <span class="string">&quot;toothbrush&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># bgr鏍煎紡鍥剧墖杞崲鎴?NV12鏍煎紡</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bgr2nv12_opencv</span>(<span class="params">image</span>):</span><br><span class="line">    height, width = image.shape[<span class="number">0</span>], image.shape[<span class="number">1</span>]</span><br><span class="line">    area = height * width</span><br><span class="line">    yuv420p = cv2.cvtColor(image, cv2.COLOR_BGR2YUV_I420).reshape((area * <span class="number">3</span> // <span class="number">2</span>,))</span><br><span class="line">    y = yuv420p[:area]</span><br><span class="line">    uv_planar = yuv420p[area:].reshape((<span class="number">2</span>, area // <span class="number">4</span>))</span><br><span class="line">    uv_packed = uv_planar.transpose((<span class="number">1</span>, <span class="number">0</span>)).reshape((area // <span class="number">2</span>,))</span><br><span class="line"></span><br><span class="line">    nv12 = np.zeros_like(yuv420p)</span><br><span class="line">    nv12[:height * width] = y</span><br><span class="line">    nv12[height * width:] = uv_packed</span><br><span class="line">    <span class="keyword">return</span> nv12</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">draw_bboxs</span>(<span class="params">image, bboxes, classes=get_classes(<span class="params"></span>)</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;draw the bboxes in the original image</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    num_classes = <span class="built_in">len</span>(classes)</span><br><span class="line">    image_h, image_w, channel = image.shape</span><br><span class="line">    hsv_tuples = [(<span class="number">1.0</span> * x / num_classes, <span class="number">1.</span>, <span class="number">1.</span>) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(num_classes)]</span><br><span class="line">    colors = <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: colorsys.hsv_to_rgb(*x), hsv_tuples))</span><br><span class="line">    colors = <span class="built_in">list</span>(</span><br><span class="line">        <span class="built_in">map</span>(<span class="keyword">lambda</span> x: (<span class="built_in">int</span>(x[<span class="number">0</span>] * <span class="number">255</span>), <span class="built_in">int</span>(x[<span class="number">1</span>] * <span class="number">255</span>), <span class="built_in">int</span>(x[<span class="number">2</span>] * <span class="number">255</span>)),</span><br><span class="line">            colors))</span><br><span class="line"></span><br><span class="line">    fontScale = <span class="number">0.5</span></span><br><span class="line">    bbox_thick = <span class="built_in">int</span>(<span class="number">0.6</span> * (image_h + image_w) / <span class="number">600</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, result <span class="keyword">in</span> <span class="built_in">enumerate</span>(bboxes):</span><br><span class="line">        bbox = result[<span class="string">&#x27;bbox&#x27;</span>]  <span class="comment"># 鐭╁舰妗嗕綅缃俊鎭? </span></span><br><span class="line">        score = result[<span class="string">&#x27;score&#x27;</span>]  <span class="comment"># 寰楀垎  </span></span><br><span class="line">        <span class="built_in">id</span> = <span class="built_in">int</span>(result[<span class="string">&#x27;id&#x27;</span>])  <span class="comment"># id  </span></span><br><span class="line">        name = result[<span class="string">&#x27;name&#x27;</span>]  <span class="comment"># 绫诲埆鍚嶇О </span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># coor = limit_display_cord(bbox)</span></span><br><span class="line">        coor = [<span class="built_in">round</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> bbox]</span><br><span class="line"></span><br><span class="line">        bbox_color = colors[<span class="built_in">id</span>]</span><br><span class="line">        c1, c2 = (coor[<span class="number">0</span>], coor[<span class="number">1</span>]), (coor[<span class="number">2</span>], coor[<span class="number">3</span>])</span><br><span class="line">        cv2.rectangle(image, c1, c2, bbox_color, bbox_thick)</span><br><span class="line">        cv2.circle(image, ((c1[<span class="number">0</span>] + c2[<span class="number">0</span>]) // <span class="number">2</span>, (c1[<span class="number">1</span>] + c2[<span class="number">1</span>]) // <span class="number">2</span>), <span class="number">3</span>, (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), thickness=bbox_thick)</span><br><span class="line">        Center = (((c2[<span class="number">0</span>] - c1[<span class="number">0</span>]) / <span class="number">2</span> + c1[<span class="number">0</span>]), ((c2[<span class="number">1</span>] - c1[<span class="number">1</span>]) / <span class="number">2</span> + c1[<span class="number">1</span>]))</span><br><span class="line">        cv2.putText(image, <span class="built_in">str</span>(Center), ((c1[<span class="number">0</span>] + c2[<span class="number">0</span>]) // <span class="number">2</span>, (c1[<span class="number">1</span>] + c2[<span class="number">1</span>]) // <span class="number">2</span>), <span class="number">0</span>, <span class="number">0.8</span>, (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>),  thickness=<span class="number">4</span>, lineType=cv2.LINE_AA)</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">str</span>(<span class="built_in">int</span>((c2[<span class="number">0</span>] - c1[<span class="number">0</span>]) / <span class="number">2</span>) + c1[<span class="number">0</span>])+<span class="built_in">str</span>(<span class="built_in">int</span>((c2[<span class="number">1</span>] - c1[<span class="number">1</span>]) / <span class="number">2</span>) + c1[<span class="number">1</span>]))</span><br><span class="line">        classes_name = name</span><br><span class="line">        bbox_mess = <span class="string">&#x27;%s: %.2f&#x27;</span> % (classes_name, score)</span><br><span class="line">        t_size = cv2.getTextSize(bbox_mess,</span><br><span class="line">                                 <span class="number">0</span>,</span><br><span class="line">                                 fontScale,</span><br><span class="line">                                 thickness=bbox_thick // <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">        cv2.rectangle(image, c1, (c1[<span class="number">0</span>] + t_size[<span class="number">0</span>], c1[<span class="number">1</span>] - t_size[<span class="number">1</span>] - <span class="number">3</span>),</span><br><span class="line">                      bbox_color, -<span class="number">1</span>)</span><br><span class="line">        cv2.putText(image,</span><br><span class="line">                    bbox_mess, (c1[<span class="number">0</span>], c1[<span class="number">1</span>] - <span class="number">2</span>),</span><br><span class="line">                    cv2.FONT_HERSHEY_SIMPLEX,</span><br><span class="line">                    fontScale, (<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">                    bbox_thick // <span class="number">2</span>,</span><br><span class="line">                    lineType=cv2.LINE_AA)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; is in the picture with confidence:&#123;:.4f&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">            classes_name, score))</span><br><span class="line">    <span class="comment">#    cv2.imwrite(&quot;demo.jpg&quot;, image)</span></span><br><span class="line">    <span class="keyword">return</span> image</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_display_res</span>():</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(<span class="string">&quot;/usr/bin/get_hdmi_res&quot;</span>) == <span class="literal">False</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">640</span>, <span class="number">480</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">import</span> subprocess</span><br><span class="line">    p = subprocess.Popen([<span class="string">&quot;/usr/bin/get_hdmi_res&quot;</span>], stdout=subprocess.PIPE)</span><br><span class="line">    result = p.communicate()</span><br><span class="line">    res = result[<span class="number">0</span>].split(<span class="string">b&#x27;,&#x27;</span>)</span><br><span class="line">    res[<span class="number">1</span>] = <span class="built_in">max</span>(<span class="built_in">min</span>(<span class="built_in">int</span>(res[<span class="number">1</span>]), <span class="number">640</span>), <span class="number">0</span>)</span><br><span class="line">    res[<span class="number">0</span>] = <span class="built_in">max</span>(<span class="built_in">min</span>(<span class="built_in">int</span>(res[<span class="number">0</span>]), <span class="number">480</span>), <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(res[<span class="number">1</span>]), <span class="built_in">int</span>(res[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_properties</span>(<span class="params">pro</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;tensor type:&quot;</span>, pro.tensor_type)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;data type:&quot;</span>, pro.dtype)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;layout:&quot;</span>, pro.layout)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;shape:&quot;</span>, pro.shape)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    signal.signal(signal.SIGINT, signal_handler)</span><br><span class="line"></span><br><span class="line">    models = dnn.load(<span class="string">&#x27;../models/fcos_512x512_nv12.bin&#x27;</span>)</span><br><span class="line">    <span class="comment"># 鎵撳嵃杈撳叆 tensor 鐨勫睘鎬?    print_properties(models[0].inputs[0].properties)</span></span><br><span class="line">    <span class="comment"># 鎵撳嵃杈撳嚭 tensor 鐨勫睘鎬?    print(len(models[0].outputs))</span></span><br><span class="line">    <span class="keyword">for</span> output <span class="keyword">in</span> models[<span class="number">0</span>].outputs:</span><br><span class="line">        print_properties(output.properties)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 鎵撳紑 usb camera: /dev/video8</span></span><br><span class="line">    cap = cv2.VideoCapture(<span class="number">8</span>)</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">not</span> cap.isOpened()):</span><br><span class="line">        exit(-<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Open usb camera successfully&quot;</span>)</span><br><span class="line">    <span class="comment"># 璁剧疆usb camera鐨勮緭鍑哄浘鍍忔牸寮忎负 MJPEG锛?鍒嗚鲸鐜?640 x 480</span></span><br><span class="line">    <span class="comment"># 鍙互閫氳繃 v4l2-ctl -d /dev/video8 --list-formats-ext 鍛戒护鏌ョ湅鎽勫儚澶存敮鎸佺殑鍒嗚鲸鐜?    # 鏍规嵁搴旂敤闇€姹傝皟鏁磋閲囬泦鍥惧儚鐨勫垎杈ㄧ巼</span></span><br><span class="line">    codec = cv2.VideoWriter_fourcc( <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;J&#x27;</span>, <span class="string">&#x27;P&#x27;</span>, <span class="string">&#x27;G&#x27;</span> )</span><br><span class="line">    cap.<span class="built_in">set</span>(cv2.CAP_PROP_FOURCC, codec)</span><br><span class="line">    cap.<span class="built_in">set</span>(cv2.CAP_PROP_FPS, <span class="number">30</span>)</span><br><span class="line">    cap.<span class="built_in">set</span>(cv2.CAP_PROP_FRAME_WIDTH, <span class="number">640</span>)</span><br><span class="line">    cap.<span class="built_in">set</span>(cv2.CAP_PROP_FRAME_HEIGHT, <span class="number">480</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Get HDMI display object</span></span><br><span class="line">    disp = srcampy.Display()</span><br><span class="line">    <span class="comment"># For the meaning of parameters, please refer to the relevant documents of HDMI display</span></span><br><span class="line">    disp_w, disp_h = get_display_res()</span><br><span class="line">    disp.display(<span class="number">0</span>, disp_w, disp_h)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 鑾峰彇缁撴瀯浣撲俊鎭?    fcos_postprocess_info = FcosPostProcessInfo_t()</span></span><br><span class="line">    fcos_postprocess_info.height = <span class="number">512</span></span><br><span class="line">    fcos_postprocess_info.width = <span class="number">512</span></span><br><span class="line">    fcos_postprocess_info.ori_height = disp_h</span><br><span class="line">    fcos_postprocess_info.ori_width = disp_w</span><br><span class="line">    fcos_postprocess_info.score_threshold = <span class="number">0.5</span> </span><br><span class="line">    fcos_postprocess_info.nms_threshold = <span class="number">0.6</span></span><br><span class="line">    fcos_postprocess_info.nms_top_k = <span class="number">5</span></span><br><span class="line">    fcos_postprocess_info.is_pad_resize = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    output_tensors = (hbDNNTensor_t * <span class="built_in">len</span>(models[<span class="number">0</span>].outputs))()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(models[<span class="number">0</span>].outputs)):</span><br><span class="line">        output_tensors[i].properties.tensorLayout = get_TensorLayout(models[<span class="number">0</span>].outputs[i].properties.layout)</span><br><span class="line">        <span class="comment">#print(output_tensors[i].properties.tensorLayout)</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">len</span>( models[<span class="number">0</span>].outputs[i].properties.scale_data) == <span class="number">0</span>):</span><br><span class="line">            output_tensors[i].properties.quantiType = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            output_tensors[i].properties.quantiType = <span class="number">2</span>  </span><br><span class="line">            scale_data_tmp = models[<span class="number">0</span>].outputs[i].properties.scale_data.reshape(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, models[<span class="number">0</span>].outputs[i].properties.shape[<span class="number">3</span>])  </span><br><span class="line">            output_tensors[i].properties.scale.scaleData = scale_data_tmp.ctypes.data_as(ctypes.POINTER(ctypes.c_float))</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(models[<span class="number">0</span>].outputs[i].properties.shape)):</span><br><span class="line">            output_tensors[i].properties.validShape.dimensionSize[j] = models[<span class="number">0</span>].outputs[i].properties.shape[j]</span><br><span class="line">            output_tensors[i].properties.alignedShape.dimensionSize[j] = models[<span class="number">0</span>].outputs[i].properties.shape[j]</span><br><span class="line"></span><br><span class="line">    start_time = time()</span><br><span class="line">    image_counter = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        _ ,frame = cap.read()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># print(frame.shape)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> frame <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Failed to get image from usb camera&quot;</span>)</span><br><span class="line">        <span class="comment"># 鎶婂浘鐗囩缉鏀惧埌妯″瀷鐨勮緭鍏ュ昂瀵?        # 鑾峰彇绠楁硶妯″瀷鐨勮緭鍏ensor 鐨勫昂瀵?        h, w = models[0].inputs[0].properties.shape[2], models[0].inputs[0].properties.shape[3]</span></span><br><span class="line">        des_dim = (w, h)</span><br><span class="line">        resized_data = cv2.resize(frame, des_dim, interpolation=cv2.INTER_AREA)</span><br><span class="line"></span><br><span class="line">        nv12_data = bgr2nv12_opencv(resized_data)</span><br><span class="line"></span><br><span class="line">        t0 = time()</span><br><span class="line">        <span class="comment"># Forward</span></span><br><span class="line">        outputs = models[<span class="number">0</span>].forward(nv12_data)</span><br><span class="line">        t1 = time()</span><br><span class="line">        <span class="comment"># print(&quot;forward time is :&quot;, (t1 - t0))</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Do post process</span></span><br><span class="line">        strides = [<span class="number">8</span>, <span class="number">16</span>, <span class="number">32</span>, <span class="number">64</span>, <span class="number">128</span>]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(strides)):</span><br><span class="line">            <span class="keyword">if</span> (output_tensors[i].properties.quantiType == <span class="number">0</span>):</span><br><span class="line">                output_tensors[i].sysMem[<span class="number">0</span>].virAddr = ctypes.cast(outputs[i].buffer.ctypes.data_as(ctypes.POINTER(ctypes.c_float)), ctypes.c_void_p)</span><br><span class="line">                output_tensors[i + <span class="number">5</span>].sysMem[<span class="number">0</span>].virAddr = ctypes.cast(outputs[i + <span class="number">5</span>].buffer.ctypes.data_as(ctypes.POINTER(ctypes.c_float)), ctypes.c_void_p)</span><br><span class="line">                output_tensors[i + <span class="number">10</span>].sysMem[<span class="number">0</span>].virAddr = ctypes.cast(outputs[i + <span class="number">10</span>].buffer.ctypes.data_as(ctypes.POINTER(ctypes.c_float)), ctypes.c_void_p)</span><br><span class="line">            <span class="keyword">else</span>:      </span><br><span class="line">                output_tensors[i].sysMem[<span class="number">0</span>].virAddr = ctypes.cast(outputs[i].buffer.ctypes.data_as(ctypes.POINTER(ctypes.c_int32)), ctypes.c_void_p)</span><br><span class="line">                output_tensors[i + <span class="number">5</span>].sysMem[<span class="number">0</span>].virAddr = ctypes.cast(outputs[i + <span class="number">5</span>].buffer.ctypes.data_as(ctypes.POINTER(ctypes.c_int32)), ctypes.c_void_p)</span><br><span class="line">                output_tensors[i + <span class="number">10</span>].sysMem[<span class="number">0</span>].virAddr = ctypes.cast(outputs[i + <span class="number">10</span>].buffer.ctypes.data_as(ctypes.POINTER(ctypes.c_int32)), ctypes.c_void_p)</span><br><span class="line"></span><br><span class="line">            libpostprocess.FcosdoProcess(output_tensors[i], output_tensors[i + <span class="number">5</span>], output_tensors[i + <span class="number">10</span>], ctypes.pointer(fcos_postprocess_info), i)</span><br><span class="line"></span><br><span class="line">        result_str = get_Postprocess_result(ctypes.pointer(fcos_postprocess_info))  </span><br><span class="line">        result_str = result_str.decode(<span class="string">&#x27;utf-8&#x27;</span>)  </span><br><span class="line">        t2 = time()</span><br><span class="line">        <span class="comment"># print(&quot;FcosdoProcess time is :&quot;, (t2 - t1))</span></span><br><span class="line">        <span class="comment"># print(result_str)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># draw result</span></span><br><span class="line">        <span class="comment"># 瑙ｆ瀽JSON瀛楃涓? </span></span><br><span class="line">        data = json.loads(result_str[<span class="number">14</span>:])  </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> frame.shape[<span class="number">0</span>]!=disp_h <span class="keyword">or</span> frame.shape[<span class="number">1</span>]!=disp_w:</span><br><span class="line">            frame = cv2.resize(frame, (disp_w,disp_h), interpolation=cv2.INTER_AREA)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Draw bboxs</span></span><br><span class="line">        box_bgr = draw_bboxs(frame, data)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># cv2.imwrite(&quot;imf.jpg&quot;, box_bgr)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Convert to nv12 for HDMI display</span></span><br><span class="line">        box_nv12 = bgr2nv12_opencv(box_bgr)</span><br><span class="line">        disp.set_img(box_nv12.tobytes())</span><br><span class="line"></span><br><span class="line">        finish_time = time()</span><br><span class="line">        image_counter += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> finish_time - start_time &gt;  <span class="number">10</span>:</span><br><span class="line">            <span class="built_in">print</span>(start_time, finish_time, image_counter)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;FPS: &#123;:.2f&#125;&quot;</span>.<span class="built_in">format</span>(image_counter / (finish_time - start_time)))</span><br><span class="line">            start_time = finish_time</span><br><span class="line">            image_counter = <span class="number">0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>将<code>draw_bboxs</code>中的代码更改为如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">draw_bboxs</span>(<span class="params">image, bboxes, classes=get_classes(<span class="params"></span>)</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;draw the bboxes in the original image</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    num_classes = <span class="built_in">len</span>(classes)</span><br><span class="line">    image_h, image_w, channel = image.shape</span><br><span class="line">    hsv_tuples = [(<span class="number">1.0</span> * x / num_classes, <span class="number">1.</span>, <span class="number">1.</span>) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(num_classes)]</span><br><span class="line">    colors = <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: colorsys.hsv_to_rgb(*x), hsv_tuples))</span><br><span class="line">    colors = <span class="built_in">list</span>(</span><br><span class="line">        <span class="built_in">map</span>(<span class="keyword">lambda</span> x: (<span class="built_in">int</span>(x[<span class="number">0</span>] * <span class="number">255</span>), <span class="built_in">int</span>(x[<span class="number">1</span>] * <span class="number">255</span>), <span class="built_in">int</span>(x[<span class="number">2</span>] * <span class="number">255</span>)),</span><br><span class="line">            colors))</span><br><span class="line"></span><br><span class="line">    fontScale = <span class="number">0.5</span></span><br><span class="line">    bbox_thick = <span class="built_in">int</span>(<span class="number">0.6</span> * (image_h + image_w) / <span class="number">600</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, result <span class="keyword">in</span> <span class="built_in">enumerate</span>(bboxes):</span><br><span class="line">        bbox = result[<span class="string">&#x27;bbox&#x27;</span>]  <span class="comment"># 鐭╁舰妗嗕綅缃俊鎭? </span></span><br><span class="line">        score = result[<span class="string">&#x27;score&#x27;</span>]  <span class="comment"># 寰楀垎  </span></span><br><span class="line">        <span class="built_in">id</span> = <span class="built_in">int</span>(result[<span class="string">&#x27;id&#x27;</span>])  <span class="comment"># id  </span></span><br><span class="line">        name = result[<span class="string">&#x27;name&#x27;</span>]  <span class="comment"># 绫诲埆鍚嶇О </span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># coor = limit_display_cord(bbox)</span></span><br><span class="line">        coor = [<span class="built_in">round</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> bbox]</span><br><span class="line">        bbox_color = colors[<span class="built_in">id</span>]</span><br><span class="line">        c1, c2 = (coor[<span class="number">0</span>], coor[<span class="number">1</span>]), (coor[<span class="number">2</span>], coor[<span class="number">3</span>])</span><br><span class="line">        classes_name = name</span><br><span class="line">        <span class="keyword">if</span> classes_name == <span class="string">&quot;person&quot;</span>:</span><br><span class="line">            cv2.rectangle(image, c1, c2, bbox_color, bbox_thick)</span><br><span class="line">            cv2.circle(image, ((c1[<span class="number">0</span>] + c2[<span class="number">0</span>]) // <span class="number">2</span>, (c1[<span class="number">1</span>] + c2[<span class="number">1</span>]) // <span class="number">2</span>), <span class="number">3</span>, (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), thickness=bbox_thick)</span><br><span class="line">            Center = (((c2[<span class="number">0</span>] - c1[<span class="number">0</span>]) / <span class="number">2</span> + c1[<span class="number">0</span>]), ((c2[<span class="number">1</span>] - c1[<span class="number">1</span>]) / <span class="number">2</span> + c1[<span class="number">1</span>]))</span><br><span class="line">            cv2.putText(image, <span class="built_in">str</span>(Center), ((c1[<span class="number">0</span>] + c2[<span class="number">0</span>]) // <span class="number">2</span>, (c1[<span class="number">1</span>] + c2[<span class="number">1</span>]) // <span class="number">2</span>), <span class="number">0</span>, <span class="number">0.8</span>, (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>),  thickness=<span class="number">4</span>, lineType=cv2.LINE_AA)</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>(<span class="built_in">int</span>((c2[<span class="number">0</span>] - c1[<span class="number">0</span>]) / <span class="number">2</span>) + c1[<span class="number">0</span>])+<span class="built_in">str</span>(<span class="built_in">int</span>((c2[<span class="number">1</span>] - c1[<span class="number">1</span>]) / <span class="number">2</span>) + c1[<span class="number">1</span>]))</span><br><span class="line">            bbox_mess = <span class="string">&#x27;%s: %.2f&#x27;</span> % (classes_name, score)</span><br><span class="line">            t_size = cv2.getTextSize(bbox_mess,</span><br><span class="line">                                 <span class="number">0</span>,</span><br><span class="line">									fontScale,</span><br><span class="line">                                 thickness=bbox_thick // <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">            cv2.rectangle(image, c1, (c1[<span class="number">0</span>] + t_size[<span class="number">0</span>], c1[<span class="number">1</span>] - t_size[<span class="number">1</span>] - <span class="number">3</span>),</span><br><span class="line">						bbox_color, -<span class="number">1</span>)</span><br><span class="line">            cv2.putText(image,</span><br><span class="line">						bbox_mess, (c1[<span class="number">0</span>], c1[<span class="number">1</span>] - <span class="number">2</span>),</span><br><span class="line">						cv2.FONT_HERSHEY_SIMPLEX,</span><br><span class="line">						fontScale, (<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">						bbox_thick // <span class="number">2</span>,</span><br><span class="line">						lineType=cv2.LINE_AA)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; is in the picture with confidence:&#123;:.4f&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">            classes_name, score))</span><br><span class="line">    <span class="comment">#    cv2.imwrite(&quot;demo.jpg&quot;, image)</span></span><br><span class="line">    <span class="keyword">return</span> image</span><br></pre></td></tr></table></figure>
<p>一定要注意缩进和tab问题</p>
<p>命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sunrise@ubuntu:~$ cd /app/pydev_demo/02_usb_camera_sample/</span><br><span class="line">sunrise@ubuntu:/app/pydev_demo/02_usb_camera_sample$ sudo python3 ./usb_camera_fcos.py</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<p><img src="/2024/10/28/2/88.png" alt></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://bl-zjl-og.cn">Zhang JianLin</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://bl-zjl-og.cn/2024/10/28/2/">http://bl-zjl-og.cn/2024/10/28/2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://bl-zjl-og.cn" target="_blank">zzzzzzjl</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/yolov5/">yolov5</a><a class="post-meta__tags" href="/tags/STM32/">STM32</a><a class="post-meta__tags" href="/tags/python/">python</a><a class="post-meta__tags" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89/">计算机视觉</a><a class="post-meta__tags" href="/tags/fcos/">fcos</a></div><div class="post-share"><div class="social-share" data-image="/img/cover1.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="prev-post pull-left" href="/2024/11/18/3/" title="从传统控制理论到模型预测控制的数学原理"><img class="cover" src="/img/cover2.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">从传统控制理论到模型预测控制的数学原理</div></div></a><a class="next-post pull-right" href="/2024/10/23/1/" title="hexo+github+zeabur博客部署方案&amp;git项目管理"><img class="cover" src="/img/cover4.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">hexo+github+zeabur博客部署方案&amp;git项目管理</div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info is-center"><div class="avatar-img"><img src="/img/head1.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Zhang JianLin</div><div class="author-info-description">张健林</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">3</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/SAINT784167"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/SAINT784167" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:saint030328@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">目前网站版本：2024.10.23 V1.0正式版本，新增搜索;</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Eyolov5%E3%80%81fcos%E7%9A%84%E7%9B%AE%E6%A0%87%E8%AF%86%E5%88%AB%E8%B7%9F%E8%B8%AA%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.</span> <span class="toc-text">基于yolov5、fcos的目标识别跟踪系统</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1-amp-%E5%BC%95%E8%84%9A%E5%88%86%E9%85%8D%E3%80%82"><span class="toc-number">2.</span> <span class="toc-text">方案设计&amp;引脚分配。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9C%A8%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%9C%AC%E5%9C%B0%E4%B8%8B%E8%BD%BD%E5%B9%B6%E5%BA%94%E7%94%A8yolo%E7%AE%97%E6%B3%95%E3%80%82"><span class="toc-number">3.</span> <span class="toc-text">在计算机本地下载并应用yolo算法。</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83%E3%80%82"><span class="toc-number">3.0.1.</span> <span class="toc-text">配置环境。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E8%BF%90%E8%A1%8CYOLOV5%E3%80%82"><span class="toc-number">3.0.2.</span> <span class="toc-text">本地运行YOLOV5。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E6%96%87%E4%BB%B6export%E3%80%82"><span class="toc-number">3.0.3.</span> <span class="toc-text">将文件export。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B7%9F%E8%B8%AA%E6%80%9D%E8%B7%AF%EF%BC%9A%E4%B8%8B%E4%BD%8D%E6%9C%BA%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91%E4%B8%8E%E6%BA%90%E4%BB%A3%E7%A0%81"><span class="toc-number">4.</span> <span class="toc-text">跟踪思路：下位机处理逻辑与源代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9D%90%E6%A0%87%E7%B3%BB%E8%BD%AC%E6%8D%A2"><span class="toc-number">4.0.1.</span> <span class="toc-text">坐标系转换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%84%A6%E8%B7%9D%E5%8F%98%E6%8D%A2-%E5%9D%90%E6%A0%87%E7%B3%BB%E8%BD%AC%E6%8D%A2%EF%BC%88%E6%9C%AA%E9%AA%8C%E8%AF%81%EF%BC%89"><span class="toc-number">4.0.2.</span> <span class="toc-text">焦距变换+坐标系转换（未验证）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E4%BD%8D%E6%9C%BA%E6%8E%A7%E5%88%B6%E4%BB%A3%E7%A0%81"><span class="toc-number">4.0.3.</span> <span class="toc-text">下位机控制代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9C%A8%E6%A0%91%E8%8E%93%E6%B4%BE%EF%BC%88%E5%9C%B0%E5%B9%B3%E7%BA%BFX3%E6%B4%BE%EF%BC%89%E4%B8%AD%E4%BD%BF%E7%94%A8yolov5%E7%AE%97%E6%B3%95%EF%BC%88fcos%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E7%AE%97%E6%B3%95%EF%BC%89%E3%80%82"><span class="toc-number">5.</span> <span class="toc-text">在树莓派（地平线X3派）中使用yolov5算法（fcos目标检测算法）。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9C%B0%E5%B9%B3%E7%BA%BFx3%E6%B4%BE%E4%B8%8E%E4%B8%8B%E4%BD%8D%E6%9C%BA%E9%80%9A%E8%AE%AF%E3%80%82"><span class="toc-number">6.</span> <span class="toc-text">地平线x3派与下位机通讯。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B6%E5%AE%83"><span class="toc-number">7.</span> <span class="toc-text">其它</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A5%E5%85%85x3%E6%B4%BE%E4%BD%BF%E7%94%A8%E8%BF%87%E7%A8%8B%EF%BC%9A"><span class="toc-number">7.1.</span> <span class="toc-text">补充x3派使用过程：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%B6%E4%BD%9C%E5%A5%BD%E5%90%AF%E5%8A%A8%E7%9B%98"><span class="toc-number">7.1.1.</span> <span class="toc-text">制作好启动盘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%94%B9%E8%87%AA%E5%B7%B1%E7%94%B5%E8%84%91%E8%87%B3%E9%9D%99%E6%80%81IP%E5%9C%B0%E5%9D%80"><span class="toc-number">7.1.2.</span> <span class="toc-text">更改自己电脑至静态IP地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%A0%BC%E5%BC%8F%E6%89%93%E5%BC%80%E7%B3%BB%E7%BB%9F%E5%B9%B6%E8%BF%9B%E8%A1%8C%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE%E3%80%82"><span class="toc-number">7.1.3.</span> <span class="toc-text">使用命令行格式打开系统并进行基础配置。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E5%85%A5%E7%B3%BB%E7%BB%9F%E9%A1%B5%E9%9D%A2%E5%B9%B6%E6%9F%A5%E7%9C%8B%E9%85%8D%E7%BD%AE%E5%A5%BD%E7%9A%84fcos%E7%9A%84python%E5%88%97%E8%A1%A8%E5%B9%B6%E8%BF%9B%E8%A1%8C%E4%BF%AE%E6%94%B9%EF%BC%8C%E6%9F%A5%E7%9C%8B%E6%91%84%E5%83%8F%E5%A4%B4%E9%93%BE%E6%8E%A5%E6%83%85%E5%86%B5"><span class="toc-number">7.1.4.</span> <span class="toc-text">进入系统页面并查看配置好的fcos的python列表并进行修改，查看摄像头链接情况</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/11/18/3/" title="从传统控制理论到模型预测控制的数学原理"><img src="/img/cover2.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="从传统控制理论到模型预测控制的数学原理"/></a><div class="content"><a class="title" href="/2024/11/18/3/" title="从传统控制理论到模型预测控制的数学原理">从传统控制理论到模型预测控制的数学原理</a><time datetime="2024-11-17T16:00:00.000Z" title="发表于 2024-11-18 00:00:00">2024-11-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/28/2/" title="基于yolov5、fcos的目标识别跟踪系统"><img src="/img/cover1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="基于yolov5、fcos的目标识别跟踪系统"/></a><div class="content"><a class="title" href="/2024/10/28/2/" title="基于yolov5、fcos的目标识别跟踪系统">基于yolov5、fcos的目标识别跟踪系统</a><time datetime="2024-10-27T16:00:00.000Z" title="发表于 2024-10-28 00:00:00">2024-10-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/23/1/" title="hexo+github+zeabur博客部署方案&amp;git项目管理"><img src="/img/cover4.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="hexo+github+zeabur博客部署方案&amp;git项目管理"/></a><div class="content"><a class="title" href="/2024/10/23/1/" title="hexo+github+zeabur博客部署方案&amp;git项目管理">hexo+github+zeabur博客部署方案&amp;git项目管理</a><time datetime="2024-10-22T16:00:00.000Z" title="发表于 2024-10-23 00:00:00">2024-10-23</time></div></div></div></div></div></div></main><footer id="footer" style="background: black;"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2024 By Zhang JianLin</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>